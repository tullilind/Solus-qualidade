<!DOCTYPE html>
<html class="light" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Bioteste Solus - Gerenciar Usuários</title>
    <link rel="icon" type="image/png" href="../logo.png">

    <!-- 1. DEPENDÊNCIAS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    
    <!-- Config do Tailwind -->
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "bioteste-primary": "#005A9C",
                        "bioteste-secondary": "#4D9DE0",
                        "bioteste-bg-light": "#F4F7FA",
                        "bioteste-text-body": "#6B7280",
                        "bioteste-text-heading": "#111827"
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                },
            },
        }
    </script>

    <style>
        body { visibility: hidden; opacity: 0; transition: opacity 0.3s ease-in-out; }
        body.loaded { visibility: visible; opacity: 1; }

        /* Modal Transitions */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>

<body class="font-display bg-bioteste-bg-light overflow-hidden">

    <!-- TOAST NOTIFICATION -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- 2. ESTRUTURA DO LAYOUT -->
    <div class="flex h-screen w-full">
        
        <!-- Sidebar (Injetado) -->
        <aside id="app-sidebar" class="fixed left-0 top-0 z-10 flex h-full w-64 flex-col bg-white/90 backdrop-blur-lg border-r border-gray-200/80 shadow-sm transition-transform duration-300 lg:translate-x-0 -translate-x-full"></aside>

        <!-- Main Content -->
        <main class="lg:ml-64 w-full flex-1 flex-col h-full overflow-y-auto relative">
            
            <!-- Header (Injetado) -->
            <header id="app-header" class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200 bg-white/80 backdrop-blur-md px-6 py-4 sticky top-0 z-20"></header>

            <!-- CONTEÚDO -->
            <div class="p-6 lg:p-10 max-w-7xl mx-auto w-full pb-24" id="main-content">
                
                <!-- Cabeçalho da Página -->
                <div class="mb-8 flex flex-col sm:flex-row justify-between items-end gap-4">
                    <div>
                        <h1 class="text-bioteste-text-heading text-3xl font-black tracking-tight">Gerenciar Usuários</h1>
                        <p class="text-bioteste-text-body mt-1">Administre o acesso, senhas e permissões dos colaboradores.</p>
                    </div>
                    <button onclick="abrirModal('criar')" class="bg-bioteste-primary text-white px-5 py-2.5 rounded-lg font-bold shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined">person_add</span>
                        Novo Usuário
                    </button>
                </div>

                <!-- Barra de Ferramentas -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-6 flex flex-col sm:flex-row gap-4 justify-between items-center">
                    <div class="relative w-full sm:w-96">
                        <span class="material-symbols-outlined absolute left-3 top-2.5 text-gray-400">search</span>
                        <input type="text" id="search-user" onkeyup="filtrarUsuarios()" placeholder="Buscar por nome, usuário ou email..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:border-bioteste-primary focus:ring-bioteste-primary text-sm">
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold" id="total-ativos">0 Ativos</span>
                        <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold" id="total-users">0 Total</span>
                    </div>
                </div>

                <!-- Tabela de Usuários -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 border-b border-gray-100 text-gray-500 uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-3 font-bold">Usuário</th>
                                    <th class="px-6 py-3 font-bold">Unidade</th>
                                    <th class="px-6 py-3 font-bold">Acesso</th>
                                    <th class="px-6 py-3 font-bold">Status</th>
                                    <th class="px-6 py-3 font-bold text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-usuarios" class="divide-y divide-gray-50 text-gray-700">
                                <!-- Skeleton Loader -->
                                <tr class="animate-pulse">
                                    <td colspan="5" class="px-6 py-10 text-center text-gray-400">Carregando usuários...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL: CRIAR / EDITAR USUÁRIO -->
    <div id="modal-usuario" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="modal-overlay absolute w-full h-full bg-black/50 backdrop-blur-sm" onclick="fecharModal()"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
            
            <!-- Header Modal -->
            <div class="modal-content py-6 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-xl font-bold text-gray-800" id="modal-title">Novo Usuário</p>
                    <div class="modal-close cursor-pointer z-50" onclick="fecharModal()">
                        <span class="material-symbols-outlined text-gray-500 hover:text-red-500">close</span>
                    </div>
                </div>

                <!-- Body Modal -->
                <form id="form-usuario" onsubmit="salvarUsuario(event)" class="space-y-4 mt-4">
                    <input type="hidden" id="user-id"> <!-- ID oculto para edição -->
                    <input type="hidden" id="user-login-original"> <!-- Login original para detectar mudança -->

                    <!-- Nome -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Nome Completo <span class="text-red-500">*</span></label>
                        <input type="text" id="input-nome" required class="w-full rounded-lg border-gray-300 focus:border-bioteste-primary focus:ring-bioteste-primary text-sm" placeholder="Ex: Maria Silva">
                    </div>

                    <!-- Email -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">E-mail (Recuperação) <span class="text-red-500">*</span></label>
                        <input type="email" id="input-email" required class="w-full rounded-lg border-gray-300 focus:border-bioteste-primary focus:ring-bioteste-primary text-sm" placeholder="email@bioteste.com">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- Usuário -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Usuário (Login) <span class="text-red-500">*</span></label>
                            <input type="text" id="input-usuario" required class="w-full rounded-lg border-gray-300 focus:border-bioteste-primary focus:ring-bioteste-primary text-sm font-mono bg-gray-50" placeholder="maria.silva">
                        </div>
                        <!-- Senha -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Senha</label>
                            <input type="text" id="input-senha" class="w-full rounded-lg border-gray-300 focus:border-bioteste-primary focus:ring-bioteste-primary text-sm font-mono" placeholder="Opcional na edição">
                            <p class="text-[10px] text-gray-400 mt-1" id="hint-senha">Deixe vazio para manter a atual.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- Acesso -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Nível de Acesso</label>
                            <select id="input-acesso" class="w-full rounded-lg border-gray-300 focus:border-bioteste-primary focus:ring-bioteste-primary text-sm">
                                <option value="funcionario">Funcionário</option>
                                <option value="adm">Administrador</option>
                                <option value="qualidade">Qualidade</option>
                            </select>
                        </div>
                        <!-- Status -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Status</label>
                            <select id="input-status" class="w-full rounded-lg border-gray-300 focus:border-bioteste-primary focus:ring-bioteste-primary text-sm">
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo (Bloqueado)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Unidade -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Unidade Vinculada</label>
                        <select id="input-unidade" class="w-full rounded-lg border-gray-300 focus:border-bioteste-primary focus:ring-bioteste-primary text-sm">
                            <option value="Matriz">Matriz</option>
                            <option value="Bioteste Rio Novo">Bioteste Rio Novo</option>
                            <option value="Bioteste Central">Bioteste Central</option>
                            <option value="Bioteste Jeronimo Monteiro">Bioteste Jeronimo Monteiro</option>
                            <option value="Bioteste Jones Dos Santos Neves">Bioteste Jones Dos Santos Neves</option>
                            <option value="Bioteste Sul">Bioteste Sul</option>
                        </select>
                    </div>

                    <!-- Footer -->
                    <div class="pt-4 flex justify-end gap-3 border-t border-gray-100 mt-4">
                        <button type="button" onclick="fecharModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-bold text-sm">Cancelar</button>
                        <button type="submit" id="btn-salvar" class="px-6 py-2 bg-bioteste-primary text-white rounded-lg hover:bg-blue-700 font-bold text-sm flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">save</span>
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 4. MÓDULOS -->
    <script src="../art.secure.js"></script>
    <script src="layout.adm.js"></script>

    <!-- 5. LÓGICA -->
    <script>
        // API de Usuários
        const API_USERS = "https://script.google.com/macros/s/AKfycbxTddEXR4zQY7oP7CLH--0AECYJa-xJsTzxwUzuF1DcsM9FXAdzYTi1pDB3BRNR5pphFg/exec";

        let allUsers = [];

        window.onload = function() {
            if (typeof BiotesteLayoutAdm !== 'undefined') {
                BiotesteLayoutAdm.init('usuarios');
            }
            carregarUsuarios();
        };

        // --- CRUD ---

        async function carregarUsuarios() {
            const tbody = document.getElementById('tabela-usuarios');
            
            try {
                const response = await fetch(`${API_USERS}?action=getUsers`);
                const result = await response.json();

                if (result.status === true && Array.isArray(result.data)) {
                    allUsers = result.data;
                    renderizarTabela(allUsers);
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-red-500">Erro ao carregar usuários.</td></tr>';
                }
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-red-500">Falha de conexão.</td></tr>';
            }
        }

        async function salvarUsuario(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btn-salvar');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin">refresh</span> Salvando...';
            btn.disabled = true;

            const id = document.getElementById('user-id').value;
            const isEdit = !!id;
            
            // Coleta dados
            const data = {
                nome: document.getElementById('input-nome').value,
                usuario: document.getElementById('input-usuario').value,
                email: document.getElementById('input-email').value,
                senha: document.getElementById('input-senha').value,
                acesso: document.getElementById('input-acesso').value,
                status: document.getElementById('input-status').value,
                unidade: document.getElementById('input-unidade').value
            };

            try {
                let url = "";
                
                if (isEdit) {
                    // UPDATE
                    url = `${API_USERS}?action=update&id=${id}&nome=${encodeURIComponent(data.nome)}&email=${encodeURIComponent(data.email)}&unidade=${encodeURIComponent(data.unidade)}&acesso=${data.acesso}&status=${data.status}`;
                    // Adiciona usuário apenas se mudou (para evitar conflito)
                    if(data.usuario !== document.getElementById('user-login-original').value) {
                         url += `&usuario=${encodeURIComponent(data.usuario)}`;
                    }
                    // Adiciona senha apenas se preenchida
                    if (data.senha) url += `&senha=${encodeURIComponent(data.senha)}`;
                } else {
                    // REGISTER
                    if (!data.senha) throw new Error("Senha é obrigatória para novos usuários.");
                    url = `${API_USERS}?action=register&nome=${encodeURIComponent(data.nome)}&usuario=${encodeURIComponent(data.usuario)}&senha=${encodeURIComponent(data.senha)}&email=${encodeURIComponent(data.email)}&unidade=${encodeURIComponent(data.unidade)}&acesso=${data.acesso}&status=${data.status}`;
                }

                const res = await fetch(url);
                const json = await res.json();

                if (json.status === true) {
                    showToast('success', isEdit ? 'Usuário atualizado!' : 'Usuário criado!');
                    fecharModal();
                    carregarUsuarios();
                } else {
                    throw new Error(json.message);
                }

            } catch (err) {
                showToast('error', err.message || "Erro ao salvar.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function deletarUsuario(id, usuario) {
            if (!confirm(`Tem certeza que deseja excluir o usuário "${usuario}"? Esta ação não pode ser desfeita.`)) return;

            try {
                const url = `${API_USERS}?action=delete&id=${id}`;
                const res = await fetch(url);
                const json = await res.json();

                if (json.status === true) {
                    showToast('success', 'Usuário excluído.');
                    carregarUsuarios();
                } else {
                    showToast('error', json.message);
                }
            } catch (e) {
                showToast('error', "Erro de conexão.");
            }
        }

        // --- UI Logic ---

        function renderizarTabela(lista) {
            const tbody = document.getElementById('tabela-usuarios');
            tbody.innerHTML = '';

            let countAtivos = 0;

            lista.forEach(u => {
                if (u.status === 'ativo') countAtivos++;
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors border-b border-gray-50";
                
                // Badges
                const badgeAccess = u.acesso === 'adm' ? 'bg-purple-100 text-purple-700 border-purple-200' : 'bg-blue-50 text-blue-700 border-blue-100';
                const badgeStatus = u.status === 'ativo' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                const iconStatus = u.status === 'ativo' ? 'check_circle' : 'block';

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-600 uppercase">
                                ${u.nome.substring(0,2)}
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">${u.nome}</div>
                                <div class="text-xs text-gray-400">@${u.usuario}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-xs font-medium text-gray-600">${u.unidade || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-md text-xs font-bold border ${badgeAccess} uppercase">${u.acesso}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="flex items-center gap-1 w-fit px-2 py-1 rounded-full text-xs font-bold ${badgeStatus}">
                            <span class="material-symbols-outlined text-[14px]">${iconStatus}</span>
                            ${u.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick='prepararEdicao(${JSON.stringify(u)})' class="p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Editar">
                                <span class="material-symbols-outlined text-lg">edit</span>
                            </button>
                            <button onclick="deletarUsuario('${u.id}', '${u.usuario}')" class="p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Excluir">
                                <span class="material-symbols-outlined text-lg">delete</span>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Counters
            document.getElementById('total-users').textContent = `${lista.length} Total`;
            document.getElementById('total-ativos').textContent = `${countAtivos} Ativos`;
        }

        function filtrarUsuarios() {
            const termo = document.getElementById('search-user').value.toLowerCase();
            const filtrados = allUsers.filter(u => 
                u.nome.toLowerCase().includes(termo) || 
                u.usuario.toLowerCase().includes(termo) ||
                u.email.toLowerCase().includes(termo)
            );
            renderizarTabela(filtrados);
        }

        // --- Modal Control ---

        function abrirModal(modo) {
            const modal = document.getElementById('modal-usuario');
            const form = document.getElementById('form-usuario');
            
            if (modo === 'criar') {
                form.reset();
                document.getElementById('user-id').value = '';
                document.getElementById('modal-title').textContent = "Novo Usuário";
                document.getElementById('input-usuario').disabled = false;
                document.getElementById('hint-senha').textContent = "Senha inicial obrigatória.";
                document.getElementById('input-senha').placeholder = "Digite a senha...";
                document.getElementById('input-senha').required = true;
                document.getElementById('input-status').value = 'ativo'; // Default
            }
            
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function prepararEdicao(user) {
            abrirModal('editar');
            document.getElementById('modal-title').textContent = "Editar Usuário";
            
            // Preenche campos
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-login-original').value = user.usuario; // Backup para comparar
            document.getElementById('input-nome').value = user.nome;
            document.getElementById('input-usuario').value = user.usuario;
            document.getElementById('input-email').value = user.email;
            document.getElementById('input-acesso').value = user.acesso;
            document.getElementById('input-status').value = user.status;
            document.getElementById('input-unidade').value = user.unidade;
            
            // Senha é opcional na edição
            document.getElementById('input-senha').value = '';
            document.getElementById('input-senha').required = false;
            document.getElementById('hint-senha').textContent = "Deixe vazio para manter a senha atual.";
        }

        function fecharModal() {
            const modal = document.getElementById('modal-usuario');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }

        // --- Helpers ---
        function showToast(type, msg) {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            const color = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? 'check_circle' : 'error';
            
            div.className = `${color} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 text-sm font-bold animate-bounce pointer-events-auto`;
            div.innerHTML = `<span class="material-symbols-outlined">${icon}</span> ${msg}`;
            
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>